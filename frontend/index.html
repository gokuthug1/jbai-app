<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="l.png" type="image/png" />
    <title>J.B.A.I</title>
    <style>
        /* Fade-Out Animation */
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }
        .fade-out {
            animation: fadeOut 0.4s ease forwards;
        }

        /* --- Theme Variables --- */
        :root {
            --bg-color: #f3f4f6;
            --sidebar-bg: #e9e9eb;
            --sidebar-border: #ddd;
            --sidebar-hover: #dcdce0;
            --sidebar-active-bg: #fff;
            --sidebar-active-border: #ccc;
            --chat-container-bg: #fff;
            --text-color: #111;
            --text-muted: #555;
            --text-secondary: #6c757d;
            --border-color: #ddd;
            --input-bg: #fff;
            --button-bg: #000;
            --button-text: #fff;
            --message-user-bg: #f0f0f0;
            --message-bot-bg: #e5e7eb;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
            --scrollbar-thumb: #ccc;
            --modal-bg: #fff;
            --modal-shadow: rgba(0, 0, 0, 0.15);
            --switch-bg: #ccc;
            --switch-handle-bg: #fff;
            --danger-color: #e53e3e;
            --danger-bg: rgba(229, 62, 62, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --sidebar-border: #333;
            --sidebar-hover: #2a2a2a;
            --sidebar-active-bg: #252525;
            --sidebar-active-border: #444;
            --chat-container-bg: #181818;
            --text-color: #e0e0e0;
            --text-muted: #aaa;
            --text-secondary: #888;
            --border-color: #333;
            --input-bg: #2a2a2a;
            --button-bg: #e0e0e0;
            --button-text: #111;
            --message-user-bg: #2c2c2c;
            --message-bot-bg: #363636;
            --code-bg: #2d2d2d;
            --code-text: #ccc;
            --scrollbar-thumb: #555;
            --modal-bg: #2a2a2a;
            --modal-shadow: rgba(0, 0, 0, 0.5);
            --switch-bg: #555;
            --switch-handle-bg: #e0e0e0;
            --danger-color: #f56565;
            --danger-bg: rgba(245, 101, 101, 0.15);
        }

        [data-theme="midnight"] {
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --sidebar-border: #30363d;
            --sidebar-hover: #21262d;
            --sidebar-active-bg: #21262d;
            --sidebar-active-border: #8b949e;
            --chat-container-bg: #0d1117;
            --text-color: #c9d1d9;
            --text-muted: #8b949e;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --input-bg: #161b22;
            --button-bg: #238636;
            --button-text: #ffffff;
            --message-user-bg: #21262d;
            --message-bot-bg: #161b22;
            --code-bg: #010409;
            --code-text: #c9d1d9;
            --scrollbar-thumb: #30363d;
            --modal-bg: #161b22;
            --modal-shadow: rgba(0, 0, 0, 0.5);
            --switch-bg: #30363d;
            --switch-handle-bg: #c9d1d9;
            --danger-color: #da3633;
            --danger-bg: rgba(218, 54, 51, 0.15);
        }
        
        [data-theme="dracula"] {
            --bg-color: #282a36;
            --sidebar-bg: #21222c;
            --sidebar-border: #44475a;
            --sidebar-hover: #44475a;
            --sidebar-active-bg: #44475a;
            --sidebar-active-border: #bd93f9;
            --chat-container-bg: #282a36;
            --text-color: #f8f8f2;
            --text-muted: #6272a4;
            --text-secondary: #6272a4;
            --border-color: #44475a;
            --input-bg: #21222c;
            --button-bg: #bd93f9;
            --button-text: #f8f8f2;
            --message-user-bg: #44475a;
            --message-bot-bg: #21222c;
            --code-bg: #191a21;
            --code-text: #f8f8f2;
            --scrollbar-thumb: #6272a4;
            --modal-bg: #21222c;
            --modal-shadow: rgba(0, 0, 0, 0.5);
            --switch-bg: #6272a4;
            --switch-handle-bg: #f8f8f2;
            --danger-color: #ff5555;
            --danger-bg: rgba(255, 85, 85, 0.15);
        }
        
        [data-theme="solarized-light"] {
            --bg-color: #fdf6e3;
            --sidebar-bg: #eee8d5;
            --sidebar-border: #93a1a1;
            --sidebar-hover: #e8e1cf;
            --sidebar-active-bg: #fdf6e3;
            --sidebar-active-border: #657b83;
            --chat-container-bg: #fdf6e3;
            --text-color: #586e75;
            --text-muted: #93a1a1;
            --text-secondary: #93a1a1;
            --border-color: #93a1a1;
            --input-bg: #eee8d5;
            --button-bg: #268bd2;
            --button-text: #fdf6e3;
            --message-user-bg: #eee8d5;
            --message-bot-bg: #eee8d5;
            --code-bg: #002b36;
            --code-text: #93a1a1;
            --scrollbar-thumb: #93a1a1;
            --modal-bg: #eee8d5;
            --modal-shadow: rgba(0, 0, 0, 0.15);
            --switch-bg: #93a1a1;
            --switch-handle-bg: #fdf6e3;
            --danger-color: #dc322f;
            --danger-bg: rgba(220, 50, 47, 0.1);
        }

        /* Base Styles */
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; height: 100vh; width: 100vw;
            overflow: hidden; position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Sidebar & Toggle --- */
        #sidebar-toggle {
            position: fixed; top: 15px; left: 15px; z-index: 1100;
            background: var(--input-bg); border: 1px solid var(--border-color);
            border-radius: 8px; width: 40px; height: 40px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: left 0.35s ease-in-out; color: var(--text-color);
        }
        #sidebar-toggle svg { stroke: currentColor; }
        .close-icon { display: none; }
        .open-icon { display: block; }
        body.sidebar-open .close-icon { display: block; }
        body.sidebar-open .open-icon { display: none; }
        body.sidebar-open #sidebar-toggle { left: 276px; }

        .sidebar {
            width: 260px; background-color: var(--sidebar-bg);
            display: flex; flex-direction: column;
            padding: 10px; border-right: 1px solid var(--sidebar-border);
            flex-shrink: 0; transition: margin-left 0.35s ease-in-out;
            height: 100%; box-sizing: border-box;
            z-index: 1000;
            margin-left: -281px;
        }
        body.sidebar-open .sidebar {
            margin-left: 0;
        }

        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 50px 10px 0 10px; flex-shrink: 0;
        }
        #new-chat-btn {
            background: var(--input-bg); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: 6px;
            padding: 8px 12px; cursor: pointer; font-size: 14px;
        }
        #new-chat-btn:hover { background-color: var(--sidebar-hover); }

        .conversation-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .conversation-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer;
            border: 1px solid transparent; user-select: none; gap: 10px;
        }
        .conversation-title {
             white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1;
        }
        .conversation-item:hover { background-color: var(--sidebar-hover); }
        .conversation-item.active {
            background-color: var(--sidebar-active-bg); border-color: var(--sidebar-active-border); font-weight: bold;
        }
        .delete-btn {
            background: none; border: none; cursor: pointer; padding: 4px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s; color: var(--text-muted); flex-shrink: 0;
        }
        .conversation-item:hover .delete-btn { opacity: 0.6; }
        .delete-btn:hover { opacity: 1; color: var(--danger-color); }
        .conversation-list::-webkit-scrollbar { width: 6px; }
        .conversation-list::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 3px; }
        
        /* Chat Container */
        .chat-container {
            display: flex; flex-direction: column; flex-grow: 1; height: 100vh;
            background-color: var(--chat-container-bg); overflow: hidden; position: relative;
        }

        /* Message Area */
        .message-area {
            flex-grow: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
            width: 100%; box-sizing: border-box; scrollbar-width: none;
        }
        .message-area::-webkit-scrollbar { display: none; }

        /* Message Styles */
        .message {
            display: flex; max-width: 100%; align-items: flex-start; box-sizing: border-box;
        }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .message-content {
            padding: 8px 12px; border-radius: 16px; max-width: 800px;
            word-wrap: break-word; white-space: pre-wrap; box-sizing: border-box;
            line-height: 1.45; position: relative;
            cursor: default; /* Changed from pointer to default */
        }
        /* New Rule: Set cursor to text for text-based elements */
        .message-content p, .message-content h1, .message-content h2, .message-content h3, .message-content li {
            cursor: text;
        }
        .message.user .message-content { background-color: var(--message-user-bg); }
        .message.bot .message-content { background-color: var(--message-bot-bg); }
        .message.bot .message-content p:first-child, .message.bot .message-content h1:first-child,
        .message.bot .message-content h2:first-child, .message.bot .message-content h3:first-child { margin-top: 0; }
        .message.bot .message-content p:last-child { margin-bottom: 0; }
        
        .copy-button {
            position: absolute; bottom: 8px; right: 8px;
            background: rgba(0,0,0,0.1); border: none; border-radius: 5px;
            cursor: pointer; padding: 4px; opacity: 0;
            transition: opacity 0.2s, background-color 0.2s;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-color);
        }
        .message-content:hover .copy-button { opacity: 0.7; }
        .copy-button:hover { opacity: 1; background: rgba(0,0,0,0.2); }
        .copy-button svg { width: 16px; height: 16px; stroke: currentColor; }

        /* Code Block Styles */
        .message-content pre {
            position: relative; background-color: var(--code-bg); color: var(--code-text);
            padding: 12px; border-radius: 8px; overflow-x: auto;
            font-family: 'SF Mono', 'Fira Code', 'Courier New', Courier, monospace;
            font-size: 0.9em; white-space: pre; padding-top: 35px;
            cursor: text;
        }
        .copy-code-button {
            position: absolute; top: 8px; right: 8px; background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; padding: 4px 8px; 
            opacity: 0; transition: opacity 0.2s, background-color 0.2s;
            display: flex; align-items: center; justify-content: center;
            color: var(--code-text); font-size: 12px;
        }
        .message-content pre:hover .copy-code-button { opacity: 0.7; }
        .copy-code-button:hover { opacity: 1; background: rgba(255, 255, 255, 0.2); }
        .copy-code-button svg { width: 14px; height: 14px; stroke: currentColor; margin-right: 5px; }
        
        .message.thinking .message-content {
            color: var(--text-secondary); font-weight: bold; background-color: transparent; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Chat Input Area */
        .chat-input-container {
            padding: 10px 20px; border-top: 1px solid var(--border-color);
            background-color: var(--chat-container-bg); flex-shrink: 0;
        }
        .chat-input-wrapper {
            display: flex; align-items: flex-end; gap: 10px; max-width: 900px; margin: 0 auto;
        }
        textarea {
            flex-grow: 1; border: 1px solid var(--border-color); border-radius: 12px;
            padding: 10px; resize: none; outline: none; max-height: 200px;
            font-size: 16px; background-color: var(--input-bg); color: var(--text-color); line-height: 1.5;
        }
        #toggle-options-button, #send-button {
            background-color: var(--button-bg); color: var(--button-text); border: none;
            border-radius: 50%; width: 40px; height: 40px; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s;
            flex-shrink: 0;
        }
        #send-button svg path, #toggle-options-button svg path { fill: var(--button-text); }

        /* Modal & Settings Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .settings-card {
            background-color: var(--modal-bg); border-radius: 12px; padding: 25px;
            width: 90%; max-width: 350px; box-shadow: 0 4px 20px var(--modal-shadow);
            text-align: left; animation: slideIn 0.3s ease-out; color: var(--text-color); box-sizing: border-box; 
        }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .settings-card h2 { margin-top: 0; font-size: 20px; }
        .settings-row { margin: 20px 0; display: flex; align-items: center; justify-content: space-between; }
        .settings-card select, .settings-card .volume-slider {
            max-width: 150px; padding: 6px; font-size: 14px; background: var(--input-bg);
            color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px;
        }
        .settings-card button {
            width: 100%; padding: 12px; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 8px;
            background-color: var(--input-bg); color: var(--text-color);
            font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, border-color 0.2s;
        }
        .settings-card button:hover { background-color: var(--sidebar-hover); }
        .settings-card .btn-primary {
            background-color: var(--button-bg); color: var(--button-text); border-color: var(--button-bg);
        }
        .settings-card .btn-danger {
            color: var(--danger-color); border-color: var(--danger-color);
        }
        .settings-card .btn-danger:hover {
            background-color: var(--danger-bg);
        }
        .settings-card hr { border: none; border-top: 1px solid var(--border-color); margin: 25px 0; }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--switch-bg); transition: 0.4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: var(--switch-handle-bg); transition: 0.4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--button-bg); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* New styles for image container and download button */
        .generated-image-wrapper {
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .image-prompt-text {
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-muted);
        }
        .image-container {
            position: relative;
            max-width: 100%;
            display: inline-block;
        }
        .generated-image {
            max-width: 100%;
            border-radius: 8px;
            display: block; 
        }
        .download-image-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            padding: 5px;
            opacity: 0;
            transition: opacity 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-container:hover .download-image-button {
            opacity: 0.9;
        }
        .download-image-button:hover {
            background: rgba(0, 0, 0, 0.6);
        }
        .download-image-button svg {
            width: 18px;
            height: 18px;
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .message-content { max-width: 90%; }
            .chat-input-container { padding: 10px; }
            body.sidebar-open #sidebar-toggle { left: 271px; }
        }
    </style>
</head>
<body>
    <button id="sidebar-toggle" title="Toggle Sidebar" type="button">
        <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="11 17 6 12 11 7"></polyline><polyline points="18 17 13 12 18 7"></polyline></svg>
        <svg class="open-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg>
    </button>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>History</h2>
            <button id="new-chat-btn" type="button">New Chat</button>
        </div>
        <div class="conversation-list" id="conversation-list"></div>
    </div>
    
    <div class="chat-container">
        <div id="message-area" class="message-area"></div>
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <button id="toggle-options-button" title="Settings" type="button">
                    <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.14,12.94c0-.32.06-.63.06-.94s-.06-.63-.06-.94l2.03-1.58a.5.5,0,0,0,.12-.59l-1.92-3.32a.5.5,0,0,0-.57-.2l-2.39.96a7.007,7.007,0,0,0-1.63-.94L14,2.5a.5.5,0,0,0-.5-.5h-3a.5.5,0,0,0-.5.5L9,5.08a7.007,7.007,0,0,0-1.63.94l-2.39-.96a.5.5,0,0,0-.57.2L2.49,8.52a.5.5,0,0,0,.12.59l2.03,1.58c0,.32-.06.63-.06-.94s.06.63.06.94L2.61,14.5a.5.5,0,0,0-.12.59l1.92,3.32a.5.5,0,0,0,.57.2l2.39-.96a7.007,7.007,0,0,0,1.63.94l.5,2.58a.5.5,0,0,0,.5.42h3a.5.5,0,0,0,.5-.42l.5-2.58a7.007,7.007,0,0,0,1.63-.94l2.39.96a.5.5,0,0,0,.57-.2l1.92-3.32a.5.5,0,0,0-.12-.59ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" fill="currentColor" stroke="none"/></svg>
                </button>
                <textarea id="chat-input" placeholder="Type your message..." rows="1"></textarea>
                <button id="send-button" title="Send Message" type="button">
                    <svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"></path></svg>
                </button>
            </div>
        </div>
    </div>
<script>
// --- Global State ---
let currentConversation = [];
let allConversations = [];
let currentChatId = null;
let ttsEnabled = false;
let selectedVoice = null;
let ttsVolume = 1;
let filteredVoices = [];
let isGenerating = false;
let typingInterval = null;

const TEXT_API_URL = 'https://jbai-app.onrender.com/api/generate';
const IMAGE_API_URL = '/api/img-gen'; // Set to your chosen endpoint

// --- Helper Functions ---
function escapeHTML(str) {
    const p = document.createElement('p');
    p.textContent = str;
    return p.innerHTML;
}

// --- Core Application Logic ---
function initApp() {
    const savedTheme = localStorage.getItem('jbai_theme') || 'light';
    applyTheme(savedTheme);
    try {
        allConversations = JSON.parse(localStorage.getItem('jbai_conversations')) || [];
    } catch (e) {
        console.error("Failed to parse conversations, resetting.", e);
        allConversations = [];
    }
    if (window.innerWidth > 768) {
        document.body.classList.add('sidebar-open');
    }
    loadSidebar();
    startNewChat();
    setupEventListeners();
    setupUploadListener();
}

function setupEventListeners() {
    const chatInput = document.getElementById('chat-input');
    document.getElementById('new-chat-btn').addEventListener('click', startNewChat);
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
        document.body.classList.toggle('sidebar-open');
    });
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChat(); }
    });
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = `${chatInput.scrollHeight}px`;
    });
    document.getElementById('send-button').addEventListener('click', handleChat);
    document.getElementById('toggle-options-button').addEventListener('click', showSettingsModal);
}

function startNewChat() {
    if (isGenerating) { clearInterval(typingInterval); isGenerating = false; }
    currentConversation = [];
    currentChatId = null;
    document.getElementById('message-area').innerHTML = '';
    const chatInput = document.getElementById('chat-input');
    chatInput.value = '';
    chatInput.style.height = 'auto';
    document.querySelectorAll('.conversation-item.active').forEach(el => el.classList.remove('active'));
}

function loadSidebar() {
    const listElement = document.getElementById('conversation-list');
    listElement.innerHTML = '';
    allConversations.sort((a, b) => b.id - a.id).forEach(chat => {
        const item = document.createElement('div');
        item.className = 'conversation-item';
        item.dataset.chatId = chat.id;
        if (chat.id === currentChatId) item.classList.add('active');
        const titleSpan = document.createElement('span');
        titleSpan.className = 'conversation-title';
        titleSpan.textContent = chat.title || 'Untitled Chat';
        titleSpan.title = chat.title || 'Untitled Chat';
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'delete-btn';
        deleteBtn.title = 'Delete Chat';
        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;
        item.addEventListener('click', () => loadChat(chat.id));
        deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteConversation(chat.id); });
        item.appendChild(titleSpan);
        item.appendChild(deleteBtn);
        listElement.appendChild(item);
    });
}

function deleteConversation(chatId) {
    if (confirm('Are you sure you want to delete this chat? This action is permanent.')) {
        allConversations = allConversations.filter(c => c.id !== chatId);
        saveAllConversations();
        if (currentChatId === chatId) { startNewChat(); }
        loadSidebar();
    }
}

function loadChat(chatId) {
    const chat = allConversations.find(c => c.id === chatId);
    if (!chat || !Array.isArray(chat.history)) {
        console.error("Chat not found or is corrupted:", chatId);
        return;
    }

    if (isGenerating) {
        clearInterval(typingInterval);
        isGenerating = false;
    }
    currentChatId = chat.id;

    const originalLength = chat.history.length;
    const migratedHistory = chat.history.map((msg, index) => {
        if (msg && msg.content && Array.isArray(msg.content.parts)) {
            if (msg.content.role === 'bot') {
                msg.content.role = 'model';
            }
            return msg;
        }
        if (msg && msg.role && typeof msg.text !== 'undefined') {
            return {
                id: msg.id || (Date.now() + index),
                content: {
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }
            };
        }
        console.warn("Removing malformed message from history:", msg);
        return null;
    }).filter(Boolean);

    currentConversation = migratedHistory;
    
    if (migratedHistory.length !== originalLength) {
        chat.history = migratedHistory;
        saveAllConversations();
    }
    
    const messageArea = document.getElementById('message-area');
    messageArea.innerHTML = '';
    
    currentConversation.forEach(msg => {
        const text = msg.content.parts[0]?.text || '';
        const sender = msg.content.role === 'model' ? 'bot' : 'user';
        displayMessage(text, sender, msg.id);
    });

    setTimeout(() => { messageArea.scrollTop = messageArea.scrollHeight; }, 0);
    loadSidebar();
}

function saveAllConversations() {
    localStorage.setItem('jbai_conversations', JSON.stringify(allConversations));
}

async function generateTitle(chatHistory) {
    const safeHistory = chatHistory.filter(h => h.content && h.content.parts && h.content.parts[0] && !h.content.parts[0].text.startsWith('[IMAGE:'));
    if (safeHistory.length < 2) return "New Chat";

    const promptContent = `Based on this conversation, create a short, concise title (4-5 words max). Output only the title, no quotes.
        User: ${safeHistory[0].content.parts[0].text}\nAI: ${safeHistory[1].content.parts[0].text}`;
    try {
        const response = await fetch(TEXT_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptContent }] }] }),
        });
        if (!response.ok) return "New Chat";
        const data = await response.json();
        return data?.candidates?.[0]?.content?.parts?.[0]?.text.trim().replace(/["*]/g, '') || "New Chat";
    } catch (error) { console.error("Title generation failed:", error); return "New Chat"; }
}

async function saveCurrentChat() {
    if (currentConversation.length === 0) return;

    if (currentChatId) {
        const chat = allConversations.find(c => c.id === currentChatId);
        if (chat) {
            chat.history = currentConversation;
        }
    } else if (currentConversation.length >= 2) {
        const newTitle = await generateTitle(currentConversation);
        currentChatId = Date.now();
        allConversations.push({ id: currentChatId, title: newTitle, history: currentConversation });
    }
    saveAllConversations();
    loadSidebar();
}

// --- Message Display & Interaction ---
function formatMessageContent(text) {
    let html = escapeHTML(text);

    // Render our special image markdown with a download button
    // Format: [IMAGE: A cat wearing a hat](blob:https://.../uuid)
    html = html.replace(
        /\[IMAGE: (.*?)\]\((.*?)\)/g,
        (match, altText, url) => {
            const escapedAlt = escapeHTML(altText);
            // Create a somewhat safe filename from the prompt
            const safeFilename = escapedAlt.replace(/[^a-z0-9_.-]/gi, ' ').trim().replace(/\s+/g, '_').substring(0, 50) || 'generated-image';
            // Changed SVG for the download button
            return `
            <div class="generated-image-wrapper">
                <p class="image-prompt-text"><em>Image Prompt: ${escapedAlt}</em></p>
                <div class="image-container">
                    <img src="${url}" alt="${escapedAlt}" class="generated-image">
                    <a href="${url}" download="${safeFilename}.png" class="download-image-button" title="Download Image">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V3m0 12l-4-4m4 4l4-4M19 21H5" /></svg>
                    </a>
                </div>
            </div>`;
        }
    );

    // Continue with other markdown processing
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => `<pre><code class="language-${lang || 'plaintext'}">${code.trim()}</code></pre>`);
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h2>$1</h2>').replace(/^# (.*$)/gim, '<h1>$1</h1>');
    html = html.replace(/^((\s*[-*] .*\n?)+)/gm, match => `<ul>${match.trim().split('\n').map(item => `<li>${item.replace(/^\s*[-*] /, '')}</li>`).join('')}</ul>`);
    html = html.replace(/^((\s*\d+\. .*\n?)+)/gm, match => `<ol>${match.trim().split('\n').map(item => `<li>${item.replace(/^\s*\d+\. /, '')}</li>`).join('')}</ol>`);
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/__(.*?)__/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/_(.*?)_/g, '<em>$1</em>');
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Smartly wrap lines in <p> tags, avoiding elements that are already blocks (including our new <div>)
    return html.split('\n').map(line => line.trim()).filter(line => line).map(line => (!line.match(/^<(p|h[1-3]|ul|ol|pre|li|strong|em|code|div)/)) ? `<p>${line}</p>` : line).join('');
}


function addCopyButtons(contentEl, rawText) {
    if (rawText.startsWith('[IMAGE:')) return;

    const copyIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
    const checkIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
    
    if (!contentEl.querySelector('.copy-button')) {
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'copy-button';
        copyBtn.title = 'Copy full message';
        copyBtn.innerHTML = copyIcon;
        copyBtn.addEventListener('click', e => {
            e.stopPropagation();
            navigator.clipboard.writeText(rawText).then(() => {
                copyBtn.innerHTML = checkIcon;
                setTimeout(() => { copyBtn.innerHTML = copyIcon; }, 2000);
            });
        });
        contentEl.appendChild(copyBtn);
    }
    
    contentEl.querySelectorAll('pre').forEach(pre => {
        if (pre.querySelector('.copy-code-button')) return;
        const code = pre.querySelector('code');
        const copyCodeBtn = document.createElement('button');
        copyCodeBtn.type = 'button';
        copyCodeBtn.className = 'copy-code-button';
        copyCodeBtn.innerHTML = copyIcon + 'Copy';
        copyCodeBtn.addEventListener('click', e => {
            e.stopPropagation();
            navigator.clipboard.writeText(code.textContent).then(() => {
                copyCodeBtn.textContent = 'Copied!';
                setTimeout(() => { copyCodeBtn.innerHTML = copyIcon + 'Copy'; }, 2000);
            });
        });
        pre.appendChild(copyCodeBtn);
    });
}

function deleteMessage(messageId) {
    if (!confirm('Are you sure you want to delete this message?')) return;
    const index = currentConversation.findIndex(msg => msg.id === messageId);
    if (index > -1) {
        currentConversation.splice(index, 1);
        const messageEl = document.querySelector(`[data-message-id='${messageId}']`);
        if (messageEl) messageEl.classList.add('fade-out');
        setTimeout(() => messageEl?.remove(), 400);
        saveCurrentChat();
    }
}

function displayMessage(content, sender, messageId, isTyping = false) {
    const messageArea = document.getElementById('message-area');
    const messageEl = document.createElement('div');
    messageEl.className = `message ${sender}`;
    messageEl.dataset.messageId = messageId;
    const contentEl = document.createElement('div');
    contentEl.className = 'message-content';

    if (isTyping) {
        messageEl.classList.add('thinking');
        contentEl.textContent = content || "â—";
    } else {
        contentEl.innerHTML = (sender === 'bot') ? formatMessageContent(content) : escapeHTML(content);
    }
    
    messageEl.appendChild(contentEl);

    if (!isTyping) {
        addCopyButtons(contentEl, content);
        let pressTimer = null;
        messageEl.addEventListener('click', e => { if (e.shiftKey) { e.preventDefault(); deleteMessage(messageId); } });
        messageEl.addEventListener('touchstart', () => { pressTimer = setTimeout(() => { if (navigator.vibrate) navigator.vibrate(50); deleteMessage(messageId); }, 800); }, { passive: true });
        messageEl.addEventListener('touchend', () => clearTimeout(pressTimer));
        messageEl.addEventListener('touchmove', () => clearTimeout(pressTimer));
    }
    
    messageArea.appendChild(messageEl);
    messageArea.scrollTop = messageArea.scrollHeight;
    return messageEl;
}

// --- AI & System ---
async function getSystemContext() {
    const context = [];
    context.push(`- Current Date/Time: ${new Date().toLocaleString()}`);
    return `You are a helpful assistant named J.B.A.I. Use standard markdown. You have access to the user's real-time context. Use it to answer relevant questions.\nCurrent Context:\n${context.join('\n')}\n---`;
}

const generateTextResponse = async () => {
    isGenerating = true;
    const thinkingMessage = displayMessage(null, 'bot', null, true);
    const messageArea = document.getElementById('message-area');
    
    const systemInstruction = { parts: [{ text: await getSystemContext() }] };
    const apiContents = currentConversation.map(msg => msg.content);

    try {
        const response = await fetch(TEXT_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: apiContents, systemInstruction })
        });
        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        const data = await response.json();
        const botResponseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!botResponseText) throw new Error("Invalid or empty API response.");

        thinkingMessage.remove();
        
        const botMessageId = Date.now() + 1;
        const botMessageEl = displayMessage('', 'bot', botMessageId);
        const contentEl = botMessageEl.querySelector('.message-content');
        
        let i = 0;
        typingInterval = setInterval(() => {
            if (i < botResponseText.length) {
                contentEl.innerHTML += escapeHTML(botResponseText[i]);
                i++;
                if (i % 10 === 0) messageArea.scrollTop = messageArea.scrollHeight;
            } else {
                clearInterval(typingInterval);
                contentEl.innerHTML = formatMessageContent(botResponseText);
                addCopyButtons(contentEl, botResponseText);
                currentConversation.push({ id: botMessageId, content: { role: "model", parts: [{ text: botResponseText }] } });
                saveCurrentChat();
                speakTTS(botResponseText);
                isGenerating = false;
            }
        }, 1);

    } catch (error) {
        thinkingMessage.remove();
        displayMessage(`Error: ${error.message}`, 'bot', Date.now() + 1);
        isGenerating = false;
    }
};

const generateImageResponse = async (prompt) => {
    isGenerating = true;
    const thinkingMessage = displayMessage(`Generating image of "${prompt}"...`, 'bot', Date.now(), true);
    
    try {
        const response = await fetch(IMAGE_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
        // The server now sends back a raw image (a "blob").
        const imageBlob = await response.blob();
        
        // We create a temporary URL for the browser to display the image.
        const imageUrl = URL.createObjectURL(imageBlob);

        if (!imageUrl) {
            throw new Error("Could not create image URL from the response.");
        }
        
        thinkingMessage.remove();

        const botMessageId = Date.now() + 1;
        // The markdown format stays the same!
        const imageMarkdown = `[IMAGE: ${prompt}](${imageUrl})`;
        currentConversation.push({ id: botMessageId, content: { role: "model", parts: [{ text: imageMarkdown }] } });
        
        displayMessage(imageMarkdown, 'bot', botMessageId);
        saveCurrentChat();

    } catch(error) {
        thinkingMessage.remove();
        displayMessage(`Image Generation Error: ${error.message}`, 'bot', Date.now() + 1);
    } finally {
        isGenerating = false;
    }
};

const handleChat = () => {
    const chatInput = document.getElementById('chat-input');
    const userMessage = chatInput.value.trim();
    if (!userMessage || isGenerating) return;

    const userMessageId = Date.now();
    currentConversation.push({ id: userMessageId, content: { role: "user", parts: [{ text: userMessage }] } });

    displayMessage(userMessage, 'user', userMessageId);
    
    chatInput.value = ""; 
    chatInput.style.height = 'auto';

    if (userMessage.toLowerCase().startsWith('/img ')) {
        const prompt = userMessage.substring(8).trim();
        if (prompt) {
            generateImageResponse(prompt);
        } else {
            displayMessage("Please provide a prompt after `/img`. For example: `/img a cat in a spaceship`", 'bot', Date.now() + 1);
        }
    } else {
        generateTextResponse();
    }
};


// --- Settings, Theme, and Data Functions ---
function applyTheme(themeName) { document.documentElement.setAttribute('data-theme', themeName); localStorage.setItem('jbai_theme', themeName); }

function downloadAllData() {
    const dataStr = localStorage.getItem('jbai_conversations');
    if (!dataStr || dataStr === '[]') {
        alert('No conversation data to download.');
        return;
    }
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
a.href = url;
    a.download = 'jbai_conversations_backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function handleDataUpload() {
    const fileInput = document.getElementById('upload-data-input');
    if(fileInput) fileInput.click();
}

function setupUploadListener() {
    let fileInput = document.getElementById('upload-data-input');
    if (!fileInput) {
        fileInput = document.createElement('input');
        fileInput.id = 'upload-data-input';
        fileInput.type = 'file';
        fileInput.accept = '.json,application/json';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
    }
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!Array.isArray(importedData)) throw new Error("Data is not a valid array.");
                const isValid = importedData.every(c => c.id && c.title && Array.isArray(c.history));
                if (!isValid) throw new Error("JSON has incorrect format. Each item must have id, title, and history.");
                if (confirm('Successfully validated backup file. Overwrite all current conversations with this data? This cannot be undone.')) {
                    localStorage.setItem('jbai_conversations', JSON.stringify(importedData));
                    alert('Data successfully imported. The application will now reload.');
                    location.reload();
                }
            } catch (error) {
                alert(`Error importing data: ${error.message}`);
            } finally {
                event.target.value = '';
            }
        };
        reader.onerror = () => { alert('Error reading the file.'); event.target.value = ''; };
        reader.readAsText(file);
    });
}

function deleteAllData() {
    if (confirm('Are you absolutely sure you want to delete ALL your chat data?\nThis action cannot be undone.')) {
        localStorage.removeItem('jbai_conversations');
        alert('All chat data has been deleted.');
        location.reload();
    }
}

function showSettingsModal() {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    const card = document.createElement('div');
    card.className = 'settings-card';
    card.innerHTML = `<h2>Settings</h2>
        <div class="settings-row"><label for="themeSelect">Theme</label><select id="themeSelect"><option value="light">Light</option><option value="dark">Dark</option><option value="midnight">Midnight</option><option value="dracula">Dracula</option><option value="solarized-light">Solarized Light</option></select></div>
        <div class="settings-row"><label>Enable TTS</label><label class="switch"><input type="checkbox" id="ttsToggle"><span class="slider"></span></label></div>
        <div class="settings-row"><label>Voice Volume</label><input type="range" min="0" max="1" step="0.1" value="${ttsVolume}" id="volumeSlider"></div>
        <div class="settings-row"><label for="voiceSelect">Bot Voice</label><select id="voiceSelect" disabled></select></div>
        <hr>
        <button id="upload-data-btn" type="button">Upload Data</button>
        <button id="download-data-btn" type="button">Download Data</button>
        <button id="delete-data-btn" type="button" class="btn-danger">Delete All Data</button>
        <button id="closeSettingsBtn" type="button" class="btn-primary" style="margin-top: 20px;">Close</button>`;
    overlay.appendChild(card);
    document.body.appendChild(overlay);

    document.getElementById('themeSelect').value = localStorage.getItem('jbai_theme') || 'light';
    document.getElementById('themeSelect').addEventListener('change', (e) => applyTheme(e.target.value));
    document.getElementById('ttsToggle').checked = ttsEnabled;
    document.getElementById('ttsToggle').addEventListener('change', (e) => { ttsEnabled = e.target.checked; });
    document.getElementById('volumeSlider').addEventListener('input', (e) => { ttsVolume = parseFloat(e.target.value); });
    document.getElementById('voiceSelect').addEventListener('change', (e) => { if(filteredVoices[e.target.value]) selectedVoice = filteredVoices[e.target.value]; });
    
    document.getElementById('upload-data-btn').addEventListener('click', handleDataUpload);
    document.getElementById('download-data-btn').addEventListener('click', downloadAllData);
    document.getElementById('delete-data-btn').addEventListener('click', deleteAllData);
    document.getElementById('closeSettingsBtn').addEventListener('click', () => overlay.remove());
    
    populateVoiceList();
}

function speakTTS(text) {
    if (!window.speechSynthesis || !ttsEnabled || !text.trim() || text.startsWith('[IMAGE:')) return;
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text.replace(/```[\s\S]*?```/g, 'Code block.'));
    utterance.volume = ttsVolume;
    if (selectedVoice) utterance.voice = selectedVoice;
    window.speechSynthesis.speak(utterance);
}

function populateVoiceList() {
    const voiceSelect = document.getElementById('voiceSelect');
    if (!voiceSelect || typeof speechSynthesis === 'undefined') return;
    const setVoices = () => {
        filteredVoices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith("en"));
        voiceSelect.innerHTML = '';
        if (filteredVoices.length === 0) {
            voiceSelect.disabled = true; voiceSelect.innerHTML = '<option>No English voices</option>'; return;
        }
        voiceSelect.disabled = false;
        let selectedIdx = 0;
        filteredVoices.forEach((voice, i) => {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${voice.name} (${voice.lang})`;
            voiceSelect.appendChild(option);
            if (selectedVoice && selectedVoice.name === voice.name) selectedIdx = i;
        });
        voiceSelect.selectedIndex = selectedIdx;
        if (!selectedVoice) selectedVoice = filteredVoices[0];
    };
    setVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = setVoices;
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>

