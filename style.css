/* ==========================================================================
   1. Core & Setup
   ========================================================================== */
@keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes thinking-dot { 0%, 100% { transform: scale(0.5); opacity: 0.5; } 50% { transform: scale(1); opacity: 1; } }

:root { 
    /* --- LIGHT THEME (White & Black) --- */
    color-scheme: light;
    --bg-color: #ffffff;
    --sidebar-bg: #f7f7f7;
    --sidebar-border: #e0e0e0;
    --sidebar-hover: #eeeeee;
    --sidebar-active-bg: #ffffff;
    --sidebar-active-border: #000000;
    --chat-container-bg: #ffffff;
    --text-color: #000000;
    --text-secondary: #555555;
    --border-color: #e0e0e0;
    --input-bg: #f7f7f7;
    
    --button-bg: #000000;
    --button-hover-bg: #333333;
    --button-text: #ffffff;

    --message-user-bg: #e0e0e0;
    --message-bot-bg: #f2f2f2;
    
    --code-bg: #f4f4f4;
    --code-text: #000000;
    --scrollbar-thumb: #cccccc;
    
    --modal-bg: #ffffff;
    --modal-shadow: rgba(0, 0, 0, 0.15);
    
    --switch-bg: #e0e0e0;
    --switch-handle-bg: #ffffff;
    
    --danger-color: #ff0000;
    --danger-bg: rgba(255, 0, 0, 0.1);
    
    --focus-color: #000000;
    --citation-color: #0000EE;
    
    --terminal-header-bg: #e0e0e0;
    --terminal-body-bg: #f4f4f4;

    /* Callout Colors (GitHub Light) */
    --callout-note-bg: #f3f5f8; --callout-note-border: #0969da;
    --callout-tip-bg: #eefbf3; --callout-tip-border: #1a7f37;
    --callout-important-bg: #f5f3ff; --callout-important-border: #8250df;
    --callout-warning-bg: #fff8c5; --callout-warning-border: #bf8700;
    --callout-caution-bg: #ffebe9; --callout-caution-border: #cf222e;

    /* Syntax Highlighting: Light */
    --token-comment: #008000; --token-punctuation: #333333; --token-property: #000000;
    --token-selector: #800000; --token-operator: #000000; --token-keyword: #0000ff;
    --token-function: #795e26; --token-class-name: #267f99; --token-string: #a31515;
    --token-number: #098658; --token-variable: #001080; --token-tag: #800000;
    --token-attr-name: #ff0000; --token-attr-value: #0000ff; --token-doctype: #0000ff;
    --token-label: #800000; 
}

[data-theme="dark"] {
    /* --- DARK THEME (Dark Gray & White) --- */
    color-scheme: dark;
    --bg-color: #1e1e1e;
    --sidebar-bg: #252526;
    --sidebar-border: #333333;
    --sidebar-hover: #2a2d2e;
    --sidebar-active-bg: #37373d;
    --sidebar-active-border: #ffffff;
    --chat-container-bg: #1e1e1e;
    --text-color: #ffffff;
    --text-secondary: #aaaaaa;
    --border-color: #333333;
    --input-bg: #2d2d2d;
    
    --button-bg: #ffffff;
    --button-hover-bg: #e0e0e0;
    --button-text: #000000;
    
    --message-user-bg: #3a3a3a;
    --message-bot-bg: #2d2d2d;
    
    --code-bg: #1e1e1e;
    --code-text: #d4d4d4;
    --scrollbar-thumb: #424242;
    
    --modal-bg: #252526;
    --modal-shadow: rgba(0, 0, 0, 0.5);
    
    --switch-bg: #404040;
    --switch-handle-bg: #ffffff;
    
    --danger-color: #ff6b6b;
    --danger-bg: rgba(255, 107, 107, 0.15);
    
    --focus-color: #ffffff;
    --citation-color: #4ec9b0;
    
    --terminal-header-bg: #2d2d2d;
    --terminal-body-bg: #1e1e1e;

    /* Callout Colors (GitHub Dark) */
    --callout-note-bg: rgba(56,139,253,0.15); --callout-note-border: #2f81f7;
    --callout-tip-bg: rgba(46,160,67,0.15); --callout-tip-border: #3fb950;
    --callout-important-bg: rgba(163,113,247,0.15); --callout-important-border: #a371f7;
    --callout-warning-bg: rgba(187,128,9,0.15); --callout-warning-border: #d29922;
    --callout-caution-bg: rgba(248,81,73,0.15); --callout-caution-border: #f85149;

    /* Syntax Highlighting: Dark */
    --token-comment: #6a9955; --token-punctuation: #d4d4d4; --token-property: #9cdcfe;
    --token-selector: #d7ba7d; --token-operator: #d4d4d4; --token-keyword: #c586c0;
    --token-function: #dcdcaa; --token-class-name: #4ec9b0; --token-string: #ce9178;
    --token-number: #b5cea8; --token-variable: #9cdcfe; --token-tag: #569cd6;
    --token-attr-name: #9cdcfe; --token-attr-value: #ce9178; --token-doctype: #569cd6;
    --token-label: #d7ba7d;
}

[data-theme="dracula"] {
    color-scheme: dark;
    --bg-color: #282a36;
    --sidebar-bg: #21222c;
    --sidebar-border: #44475a;
    --sidebar-hover: #44475a;
    --sidebar-active-bg: #44475a;
    --sidebar-active-border: #bd93f9;
    --chat-container-bg: #282a36;
    --text-color: #f8f8f2;
    --text-secondary: #6272a4;
    --border-color: #44475a;
    --input-bg: #44475a;
    --button-bg: #bd93f9;
    --button-hover-bg: #d6acff;
    --button-text: #282a36;
    --message-user-bg: #6272a4;
    --message-bot-bg: #44475a;
    --code-bg: #21222c;
    --code-text: #f8f8f2;
    --scrollbar-thumb: #6272a4;
    --modal-bg: #282a36;
    --modal-shadow: rgba(0, 0, 0, 0.6);
    --switch-bg: #6272a4;
    --switch-handle-bg: #f8f8f2;
    --danger-color: #ff5555;
    --danger-bg: rgba(255, 85, 85, 0.2);
    --focus-color: #bd93f9;
    --citation-color: #8be9fd;
    --terminal-header-bg: #191a21;
    --terminal-body-bg: #21222c;
    
    --callout-note-bg: rgba(139,233,253,0.15); --callout-note-border: #8be9fd;
    --callout-tip-bg: rgba(80,250,123,0.15); --callout-tip-border: #50fa7b;
    --callout-important-bg: rgba(189,147,249,0.15); --callout-important-border: #bd93f9;
    --callout-warning-bg: rgba(241,250,140,0.15); --callout-warning-border: #f1fa8c;
    --callout-caution-bg: rgba(255,85,85,0.15); --callout-caution-border: #ff5555;

    --token-comment: #6272a4; --token-punctuation: #f8f8f2; --token-property: #ff79c6;
    --token-selector: #50fa7b; --token-operator: #ff79c6; --token-keyword: #ff79c6;
    --token-function: #50fa7b; --token-class-name: #8be9fd; --token-string: #f1fa8c;
    --token-number: #bd93f9; --token-variable: #8be9fd; --token-tag: #ff79c6;
    --token-attr-name: #50fa7b; --token-attr-value: #f1fa8c; --token-doctype: #6272a4;
    --token-label: #ff79c6;
}

[data-theme="monokai"] {
    color-scheme: dark;
    --bg-color: #272822;
    --sidebar-bg: #1e1f1c;
    --sidebar-border: #3e3d32;
    --sidebar-hover: #3e3d32;
    --sidebar-active-bg: #49483e;
    --sidebar-active-border: #f92672;
    --chat-container-bg: #272822;
    --text-color: #f8f8f2;
    --text-secondary: #75715e;
    --border-color: #49483e;
    --input-bg: #3e3d32;
    --button-bg: #f92672;
    --button-hover-bg: #ff4d8d;
    --button-text: #f8f8f2;
    --message-user-bg: #49483e;
    --message-bot-bg: #3e3d32;
    --code-bg: #1e1f1c;
    --code-text: #f8f8f2;
    --scrollbar-thumb: #75715e;
    --modal-bg: #272822;
    --modal-shadow: rgba(0, 0, 0, 0.6);
    --switch-bg: #75715e;
    --switch-handle-bg: #f8f8f2;
    --danger-color: #f92672;
    --danger-bg: rgba(249, 38, 114, 0.2);
    --focus-color: #f92672; 
    --citation-color: #66d9ef;
    --terminal-header-bg: #171814;
    --terminal-body-bg: #1e1f1c;

    --callout-note-bg: rgba(102,217,239,0.15); --callout-note-border: #66d9ef;
    --callout-tip-bg: rgba(166,226,46,0.15); --callout-tip-border: #a6e22e;
    --callout-important-bg: rgba(174,129,255,0.15); --callout-important-border: #ae81ff;
    --callout-warning-bg: rgba(230,219,116,0.15); --callout-warning-border: #e6db74;
    --callout-caution-bg: rgba(249,38,114,0.15); --callout-caution-border: #f92672;

    --token-comment: #75715e; --token-punctuation: #f8f8f2; --token-property: #66d9ef;
    --token-selector: #a6e22e; --token-operator: #f92672; --token-keyword: #f92672;
    --token-function: #a6e22e; --token-class-name: #66d9ef; --token-string: #e6db74;
    --token-number: #ae81ff; --token-variable: #fd971f; --token-tag: #f92672;
    --token-attr-name: #a6e22e; --token-attr-value: #e6db74; --token-doctype: #75715e;
    --token-label: #a6e22e;
}

/* ==========================================================================
   2. Base Styles
   ========================================================================== */
*, *::before, *::after { box-sizing: border-box; }
html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
body {
    display: flex; position: relative; width: 100vw; height: 100vh; height: 100dvh;
    margin: 0; padding: 0; overflow: hidden; color: var(--text-color);
    background-color: var(--bg-color);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    transition: background-color 0.3s ease, color 0.3s ease;
}
body.modal-open { overflow: hidden; }
body.offline::before {
    content: 'Offline';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10000;
    background-color: var(--danger-color);
    color: white;
    text-align: center;
    padding: 8px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* ==========================================================================
   3. Sidebar
   ========================================================================== */
.sidebar {
    position: fixed; top: 0; left: -281px; z-index: 2000;
    display: flex; flex-direction: column; flex-shrink: 0;
    width: 260px; height: 100%; padding: 10px;
    background-color: var(--sidebar-bg); border-right: 1px solid var(--sidebar-border);
    transition: left 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
body.sidebar-open .sidebar { left: 0; box-shadow: 4px 0 15px rgba(0,0,0,0.2); }
.sidebar-backdrop {
    position: fixed; inset: 0; z-index: 1999; background: rgba(0,0,0,0.5);
    opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s;
}
body.sidebar-open .sidebar-backdrop { opacity: 1; visibility: visible; transition: opacity 0.3s; }

.main-content { display: flex; flex-grow: 1; width: 100%; height: 100dvh; transition: margin-left 0.35s ease-in-out; }
.chat-container {
    display: flex; flex-direction: column; flex-grow: 1; position: relative;
    width: 100%; height: 100dvh; overflow: hidden; background-color: var(--chat-container-bg);
}

body.drag-over::before {
    content: 'Drop Files Here'; position: fixed; inset: 0; z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px); color: white;
    font-size: 2rem; font-weight: bold;
    border: 4px dashed var(--focus-color); border-radius: 12px;
    margin: 10px; animation: fadeIn 0.2s ease; pointer-events: none;
}

#sidebar-toggle {
    position: fixed; top: 15px; left: 15px; z-index: 2100;
    display: flex; align-items: center; justify-content: center;
    width: 40px; height: 40px; cursor: pointer; color: var(--text-color);
    background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 50%;
    transition: background-color 0.2s, border-color 0.2s, left 0.35s ease-in-out;
}
#sidebar-toggle:hover { background-color: var(--sidebar-hover); }
#sidebar-toggle:focus-visible { outline: 2px solid var(--focus-color); outline-offset: 2px; }
#sidebar-toggle svg { stroke: currentColor; }
.close-icon { display: none; } .open-icon { display: block; }
body.sidebar-open .close-icon { display: block; } body.sidebar-open .open-icon { display: none; }

.sidebar-header { display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; padding: 50px 10px 0 10px; margin-bottom: 15px; }
#new-chat-btn {
    padding: 8px 12px; cursor: pointer; color: var(--text-color);
    background: var(--input-bg); border: 1px solid var(--border-color);
    border-radius: 6px; font-size: 14px; transition: background-color 0.2s;
}
#new-chat-btn:hover { background-color: var(--sidebar-hover); }
.conversation-list { flex-grow: 1; padding-right: 5px; overflow-y: auto; }
.conversation-list::-webkit-scrollbar { width: 6px; }
.conversation-list::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 3px; }
.conversation-item {
    display: flex; align-items: center; justify-content: space-between; gap: 10px;
    padding: 10px; margin-bottom: 5px; user-select: none; cursor: pointer;
    border: 1px solid transparent; border-radius: 6px; outline: none; outline-offset: -2px;
}
.conversation-item:hover { background-color: var(--sidebar-hover); }
.conversation-item.active { font-weight: bold; background-color: var(--sidebar-active-bg); border-color: var(--sidebar-active-border); }
.conversation-title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.delete-btn {
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    padding: 4px; opacity: 0; visibility: hidden; cursor: pointer;
    color: var(--text-secondary); background: none; border: none; border-radius: 4px;
    transition: opacity 0.2s, color 0.2s, visibility 0.2s;
}
.conversation-item:hover .delete-btn { opacity: 0.6; visibility: visible; }
.delete-btn:hover { opacity: 1; color: var(--danger-color); }

/* ==========================================================================
   4. Message Area (Enhanced Formatting)
   ========================================================================== */
.message-area {
    display: flex; flex-direction: column; flex-grow: 1; gap: 10px;
    width: 100%; padding: 20px; overflow-y: auto; scrollbar-width: none;
    content-visibility: auto;
}
.message-area::-webkit-scrollbar { display: none; }
.message { display: flex; align-items: flex-start; max-width: 100%; }
.message.user { justify-content: flex-end; }
.message.bot { justify-content: flex-start; }
.message.thinking .message-content { display: inline-flex; align-items: center; gap: 4px; background-color: var(--message-bot-bg); }
.message.thinking .message-content span {
    display: inline-block; width: 8px; height: 8px; background-color: var(--text-secondary);
    border-radius: 50%; animation: thinking-dot 1.4s infinite ease-in-out both;
}
.message.thinking .message-content span:nth-child(1) { animation-delay: -0.32s; }
.message.thinking .message-content span:nth-child(2) { animation-delay: -0.16s; }
.message.thinking .message-content span:nth-child(3) { animation-delay: 0s; }

.message-content {
    position: relative; max-width: 800px; padding: 10px 16px;
    line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;
    cursor: default; background-color: var(--message-bot-bg); border-radius: 12px; min-width: 0;
    border: 1px solid transparent; 
}
.message.user .message-content { background-color: var(--message-user-bg); border-color: transparent; }
.message-content *:first-child { margin-top: 0; }
.message-content *:last-child { margin-bottom: 0; }

/* --- Markdown Typography --- */
.message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 {
    margin: 1em 0 0.5em 0; font-weight: 600; line-height: 1.25; color: var(--text-color);
}
.message-content h1 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
.message-content h2 { font-size: 1.3em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
.message-content h3 { font-size: 1.1em; }
.message-content h4 { font-size: 1em; }

.message-content p { margin: 0 0 10px 0; }
.message-content a:not(.citation-ref):not(.source-item) { color: var(--focus-color); text-decoration: underline; font-weight: 500; }
.message-content a:not(.citation-ref):not(.source-item):hover { text-decoration: none; }
.message-content s { text-decoration: line-through; color: var(--text-secondary); }
.message-content hr { height: 0.25em; padding: 0; margin: 24px 0; background-color: var(--border-color); border: 0; }
.message-content blockquote {
    padding: 0 1em; color: var(--text-secondary); border-left: 0.25em solid var(--border-color);
    margin: 0 0 16px 0; background-color: color-mix(in srgb, var(--message-bot-bg) 80%, var(--bg-color));
    border-radius: 0 8px 8px 0;
}
.message.user .message-content blockquote { background-color: color-mix(in srgb, var(--message-user-bg) 80%, var(--bg-color)); }

/* --- Tables (Enhanced for Mobile) --- */
.message-content table {
    display: block; width: 100%; overflow-x: auto; 
    border-collapse: collapse; margin: 10px 0;
    font-size: 0.9em; border-radius: 6px; 
    border: 1px solid var(--border-color);
    -webkit-overflow-scrolling: touch;
}
.message-content th, .message-content td {
    padding: 8px 12px; border: 1px solid var(--border-color); text-align: left;
    min-width: 100px; /* Prevents squishing on mobile */
    white-space: normal;
}
.message-content th { background-color: var(--sidebar-hover); font-weight: 600; }
.message-content tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }

/* --- Callouts --- */
.callout { padding: 12px; margin-bottom: 12px; border-left: 4px solid; border-radius: 6px; font-size: 0.95em; }
.callout-title { display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 6px; }
.callout-title svg { fill: currentColor; }
.callout-note { background-color: var(--callout-note-bg); border-color: var(--callout-note-border); }
.callout-tip { background-color: var(--callout-tip-bg); border-color: var(--callout-tip-border); }
.callout-important { background-color: var(--callout-important-bg); border-color: var(--callout-important-border); }
.callout-warning { background-color: var(--callout-warning-bg); border-color: var(--callout-warning-border); }
.callout-caution { background-color: var(--callout-caution-bg); border-color: var(--callout-caution-border); }

/* --- Task Lists --- */
.task-list-item { list-style-type: none; margin-left: -20px; }
.task-list-item input[type="checkbox"] { margin-right: 0.5em; vertical-align: middle; }
.task-list-item.checked { text-decoration: line-through; color: var(--text-secondary); }

/* --- Math & Misc --- */
.math-inline {
    font-family: "Times New Roman", Times, serif; font-style: italic;
    background-color: rgba(128,128,128,0.1); padding: 0 4px; border-radius: 3px;
}
.math-block {
    font-family: "Times New Roman", Times, serif; display: block; text-align: center;
    padding: 10px; margin: 10px 0; background-color: var(--sidebar-bg);
    border-radius: 6px; overflow-x: auto;
}
kbd {
    display: inline-block; padding: 3px 5px; font-size: 11px; line-height: 10px;
    color: var(--text-color); vertical-align: middle; background-color: var(--bg-color);
    border: 1px solid var(--border-color); border-radius: 3px;
    box-shadow: inset 0 -1px 0 var(--border-color);
}
.spoiler {
    background-color: var(--text-color); color: transparent; cursor: pointer;
    padding: 0 2px; border-radius: 2px; transition: color 0.2s, background-color 0.2s;
    user-select: none;
}
.spoiler.revealed, .spoiler:hover { background-color: var(--sidebar-hover); color: var(--text-color); }
.spoiler:hover { opacity: 0.8; }
.markdown-image { max-width: 100%; border-radius: 8px; margin: 10px 0; }

/* --- Footnotes --- */
.footnotes { font-size: 0.85em; color: var(--text-secondary); margin-top: 20px; }
.footnotes ol { padding-left: 20px; }
.footnote-ref { font-size: 0.75em; vertical-align: super; line-height: 0; }
.footnote-ref a { text-decoration: none; color: var(--citation-color); }

/* --- Sources & Citations --- */
.citation-ref {
    display: inline-flex; align-items: center; justify-content: center;
    vertical-align: super; font-size: 0.75em; font-weight: bold;
    color: var(--citation-color); text-decoration: none; margin: 0 1px;
    cursor: pointer; background: rgba(0,0,0,0.05); border-radius: 4px; padding: 0 4px;
}
.citation-ref:hover { background: rgba(0,0,0,0.1); text-decoration: underline; }
.sources-container {
    margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 0.9em;
}
.sources-container h4 { margin: 0 0 8px 0; font-size: 0.85em; text-transform: uppercase; color: var(--text-secondary); }
.sources-list { display: flex; flex-direction: column; gap: 6px; }
.source-item {
    display: flex; align-items: center; gap: 8px; text-decoration: none;
    color: var(--text-color); padding: 6px 10px; border-radius: 6px;
    background: var(--bg-color); border: 1px solid var(--border-color); transition: background-color 0.2s;
}
.source-item:hover { background-color: var(--sidebar-hover); }
.source-index {
    display: flex; align-items: center; justify-content: center;
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--citation-color); color: #fff; font-size: 11px; font-weight: bold; flex-shrink: 0;
}
.source-title { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-size: 13px; }

/* --- Preview Containers --- */
.html-preview-container, .svg-preview-container { padding-top: 8px; }
.preview-toggle-btn {
    display: flex; align-items: center; justify-content: center;
    padding: 4px; border: none; background: transparent;
    color: var(--text-secondary); border-radius: 4px; cursor: pointer;
    transition: color 0.2s, background-color 0.2s;
}
.preview-toggle-btn:hover { color: var(--text-color); background: rgba(128,128,128, 0.2); }
.preview-toggle-btn svg { width: 16px; height: 16px; fill: currentColor; stroke: none; }
.html-render-box {
    width: 100%; height: 400px; background-color: var(--chat-container-bg);
    border: 1px solid var(--border-color); border-radius: 8px;
    overflow: hidden; cursor: zoom-in; max-width: 100%;
}
.html-render-box iframe { width: 100%; height: 100%; border: none; background-color: #fff; pointer-events: none; }
.svg-render-box {
    padding: 1rem; background-color: var(--bg-color);
    border: 1px solid var(--border-color); border-radius: 8px;
    display: flex; justify-content: center; align-items: center;
    min-height: 100px; cursor: zoom-in; max-width: 100%;
}
.svg-render-box img, .svg-render-box svg { max-width: 100%; max-height: 300px; }

/* --- Attachments --- */
.message-attachments { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-bottom: 8px; }
.attachment-item {
    position: relative; width: 100%; background-color: var(--sidebar-hover);
    border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;
}
.attachment-media { display: block; width: 100%; height: 100%; object-fit: cover; }
.attachment-item:not(:has(.attachment-media)) { aspect-ratio: 1 / 1; }
.attachment-generic { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; height: 100%; padding: 8px; text-align: center; }
.attachment-generic svg { width: 40px; height: 40px; flex-shrink: 0; stroke: var(--text-secondary); }
.attachment-generic .attachment-filename { font-size: 12px; line-height: 1.2; word-break: break-all; max-height: 3.6em; overflow: hidden; color: var(--text-color); }

/* ==========================================================================
   5. Code Blocks
   ========================================================================== */
.code-block-wrapper {
    background-color: var(--code-bg); border: 1px solid var(--border-color);
    border-radius: 8px; margin: 12px 0; overflow: hidden;
}
.code-block-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 6px 12px; background-color: color-mix(in srgb, var(--code-bg) 95%, #000);
    border-bottom: 1px solid var(--border-color); font-size: 0.8em; color: var(--text-secondary);
}
.code-block-header span { font-family: 'SF Mono', 'Fira Code', 'Courier New', Courier, monospace; font-weight: 600; text-transform: uppercase; }
.code-block-actions { display: flex; align-items: center; gap: 6px; margin-left: auto; }
.message-content pre {
    padding: 12px; margin: 0; overflow-x: auto; white-space: pre; cursor: default;
    color: var(--code-text); background-color: var(--code-bg); border-radius: 0;
    font-family: 'SF Mono', 'Fira Code', 'Courier New', Courier, monospace; font-size: 0.9em;
    line-height: 1.5;
}
.code-block-wrapper.terminal-style { border: 1px solid var(--border-color); background-color: var(--terminal-body-bg); }
.code-block-header.terminal-header { background-color: var(--terminal-header-bg); border-bottom: 1px solid var(--border-color); color: var(--text-secondary); justify-content: flex-start; gap: 10px; }
.terminal-dots { display: flex; gap: 6px; margin-right: 6px; }
.terminal-dots .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
.terminal-dots .red { background-color: #ff5f56; }
.terminal-dots .yellow { background-color: #ffbd2e; }
.terminal-dots .green { background-color: #27c93f; }
pre.terminal-body { background-color: var(--terminal-body-bg); color: var(--code-text); }

.copy-button {
    position: absolute; right: 8px; bottom: 8px; padding: 4px; opacity: 0;
    color: var(--text-color); background: rgba(0,0,0,0.1); display: flex;
    align-items: center; justify-content: center; cursor: pointer; border: none;
    border-radius: 5px; transition: opacity 0.2s, background-color 0.2s;
}
.message-content:hover .copy-button { opacity: 0.7; }
.copy-button:hover { opacity: 1; background: rgba(0,0,0,0.2); }
.copy-button svg { width: 16px; height: 16px; stroke: currentColor; }
.copy-code-button, .open-new-tab-button, .download-code-button, .collapse-toggle-button {
    display: flex; align-items: center; justify-content: center; padding: 4px;
    cursor: pointer; color: var(--text-secondary); background: transparent;
    border: none; border-radius: 4px; transition: color 0.2s, background-color 0.2s;
}
.copy-code-button:hover, .open-new-tab-button:hover, .download-code-button:hover, .collapse-toggle-button:hover {
    color: var(--text-color); background: rgba(128,128,128, 0.2);
}
.copy-code-button svg, .open-new-tab-button svg, .download-code-button svg, .collapse-toggle-button svg { width: 16px; height: 16px; stroke: currentColor; }
.collapsible-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-in-out; }
.code-block-wrapper:not(.is-collapsed) .collapsible-content { grid-template-rows: 1fr; }
.collapsible-content > pre { overflow: hidden; min-height: 0; }
.collapse-toggle-button svg { transition: transform 0.3s ease; }
.code-block-wrapper.is-collapsed .collapse-toggle-button svg { transform: rotate(-90deg); }

.execution-result {
    margin: 10px 0; border-radius: 8px; background: var(--code-bg);
    border: 1px solid var(--border-color); overflow: hidden;
    font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.85em;
}
.execution-header {
    padding: 6px 12px; background: rgba(128, 128, 128, 0.1);
    color: var(--text-secondary); border-bottom: 1px solid var(--border-color); font-weight: bold;
}
.execution-result.error .execution-header { color: var(--danger-color); background: var(--danger-bg); }
.execution-result pre { margin: 0; padding: 12px; color: var(--code-text); white-space: pre-wrap; word-break: break-all; }

.generated-image-wrapper { margin: 12px 0; }
.image-prompt-text { margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9em; }
.image-container { position: relative; display: inline-block; max-width: 100%; }
.image-container:hover .download-image-button { opacity: 0.9; }
.generated-image { display: block; max-width: 100%; border-radius: 8px; cursor: zoom-in; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.download-image-button {
    position: absolute; top: 10px; right: 10px; display: flex; align-items: center;
    justify-content: center; padding: 6px; opacity: 0; cursor: pointer; color: white;
    background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px; transition: opacity 0.2s, background-color 0.2s;
}
.download-image-button:hover { background: rgba(0, 0, 0, 0.7); }
.download-image-button svg { width: 18px; height: 18px; }

.files-download-wrapper { margin: 16px 0; }
.files-download-container {
    display: flex; align-items: center; justify-content: space-between; gap: 20px;
    padding: 20px; background: linear-gradient(135deg, var(--code-bg) 0%, var(--message-bot-bg) 100%);
    border: 2px solid var(--border-color); border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}
.files-download-container:hover {
    border-color: var(--text-secondary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.files-download-info {
    display: flex; align-items: flex-start; gap: 16px; flex: 1; min-width: 0;
}
.files-download-info .files-icon {
    flex-shrink: 0; width: 32px; height: 32px; margin-top: 2px;
    color: var(--text-color); stroke: currentColor; opacity: 0.8;
}
.files-download-details { flex: 1; min-width: 0; }
.files-download-title {
    font-weight: 700; color: var(--text-color); margin-bottom: 6px;
    font-size: 16px; letter-spacing: 0.3px;
}
.files-download-list {
    font-size: 13px; color: var(--text-secondary); 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    font-family: var(--code-font, 'Courier New', monospace);
    line-height: 1.5;
}
.download-files-button {
    display: inline-flex; align-items: center; gap: 10px; padding: 12px 20px;
    background: linear-gradient(135deg, var(--button-bg) 0%, var(--button-hover-bg) 100%);
    color: var(--button-text); border: none; border-radius: 8px;
    font-size: 15px; font-weight: 600; cursor: pointer; text-decoration: none;
    transition: all 0.3s ease; flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.5px;
}
.download-files-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    background: linear-gradient(135deg, var(--button-hover-bg) 0%, var(--button-bg) 100%);
}
.download-files-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
.download-files-button svg {
    width: 20px; height: 20px; stroke: currentColor; flex-shrink: 0;
    stroke-width: 2.5;
}

/* ==========================================================================
   6. Input Area
   ========================================================================== */
.chat-input-container { flex-shrink: 0; padding: 10px 20px 20px; background-color: transparent; border-top: none; }
#file-previews-container { display: none; flex-wrap: wrap; gap: 10px; max-width: 800px; margin: 0 auto 10px auto; }
.file-preview-item {
    position: relative; width: 70px; height: 70px; border: 1px solid var(--border-color);
    border-radius: 8px; overflow: hidden; background-color: var(--sidebar-hover);
}
.file-preview-item img, .file-preview-item video { width: 100%; height: 100%; object-fit: cover; }
.remove-preview-btn {
    position: absolute; top: 2px; right: 2px; width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden;
    cursor: pointer; color: white; background: rgba(0,0,0,0.5); border: none;
    border-radius: 50%; font-size: 14px; line-height: 1; transform: scale(0.8);
    transition: opacity 0.2s, background-color 0.2s, transform 0.2s, visibility 0s 0.2s;
}
.file-preview-item:hover .remove-preview-btn { opacity: 0.7; visibility: visible; transform: scale(1); transition-delay: 0s; }
.remove-preview-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); }
.file-preview-item.generic { display: flex; align-items: center; justify-content: center; padding: 8px; }
.file-preview-item.generic svg { width: 100%; height: 100%; max-width: 40px; stroke: var(--text-secondary); }
.file-preview-extension {
    position: absolute; top: 4px; right: 4px; padding: 1px 4px; background-color: var(--button-bg);
    color: var(--button-text); border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase;
}

.chat-input-wrapper {
    display: flex; align-items: flex-end; gap: 5px; max-width: 800px; margin: 0 auto;
    padding: 6px; background-color: var(--input-bg); border: 1px solid var(--border-color);
    border-radius: 26px; transition: border-color 0.2s, box-shadow 0.2s;
}
.chat-input-wrapper:focus-within { border-color: var(--focus-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus-color) 20%, transparent); }
textarea#chat-input {
    flex-grow: 1; max-height: 200px; padding: 10px; resize: none; outline: none;
    color: var(--text-color); background: transparent; border: none; box-shadow: none; font-size: 16px; line-height: 1.5;
}
#toggle-options-button, #attach-file-button {
    display: flex; align-items: center; justify-content: center; flex-shrink: 0; width: 40px; height: 40px;
    cursor: pointer; border: none; border-radius: 50%; background-color: transparent;
    color: var(--text-secondary); transition: background-color 0.2s, color 0.2s;
}
#toggle-options-button:hover, #attach-file-button:hover { color: var(--text-color); background-color: var(--sidebar-hover); }
#toggle-options-button svg, #attach-file-button svg { stroke: currentColor; }

#send-button, #stop-button {
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    width: 40px; height: 40px; cursor: pointer; border: none; border-radius: 50%;
    background-color: var(--sidebar-hover); color: var(--text-secondary);
    transition: background-color 0.2s, color 0.2s;
}
#stop-button { background-color: var(--button-bg); color: var(--button-text); }
#stop-button:hover { background-color: var(--button-hover-bg); }
#send-button:not(:disabled) { background-color: var(--button-bg); color: var(--button-text); }
#send-button:not(:disabled):hover { background-color: var(--button-hover-bg); }
#send-button svg path { fill: currentColor; }
.fade-out { animation: fadeOut 0.4s ease forwards; }

/* ==========================================================================
   7. Modals & Overlays
   ========================================================================== */
.modal-overlay {
    position: fixed; inset: 0; z-index: 3000; display: flex; align-items: center; justify-content: center;
    background-color: rgba(0, 0, 0, 0.6); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease;
    padding: 20px;
}
.settings-card {
    width: min(450px, 95vw); max-height: 85vh; overflow-y: auto; padding: 20px;
    text-align: left; color: var(--text-color); background-color: var(--modal-bg);
    border-radius: 12px; box-shadow: 0 10px 30px var(--modal-shadow); animation: slideIn 0.3s ease-out;
}
.settings-card h2, .settings-card h3 { margin-top: 0; font-size: 20px; }
.settings-card h3 { font-size: 16px; margin-top: 25px; margin-bottom: 10px; color: var(--text-secondary); }
.settings-card hr { margin: 25px 0; border: none; border-top: 1px solid var(--border-color); }
.settings-row { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; }
.settings-group { display: flex; flex-direction: column; gap: 10px; }
.settings-group input { width: 100%; padding: 8px; color: var(--text-color); background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; }
.settings-card select {
    min-width: 120px; padding: 6px 10px; color: var(--text-color); background: var(--input-bg);
    border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;
}
.settings-card button {
    width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; color: var(--text-color);
    background-color: var(--input-bg); border: 1px solid var(--border-color);
    border-radius: 8px; font-size: 15px; font-weight: 600; transition: background-color 0.2s, border-color 0.2s;
}
.settings-card button:hover { background-color: var(--sidebar-hover); }
.settings-card .btn-primary { color: var(--button-text); background-color: var(--button-bg); border-color: var(--button-bg); }
.settings-card .btn-primary:hover { background-color: var(--button-hover-bg); border-color: var(--button-hover-bg); }
.settings-card .btn-danger { color: var(--danger-color); border-color: var(--border-color); }
.settings-card .btn-danger:hover { background-color: var(--danger-bg); border-color: var(--danger-color); }

.switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--switch-bg); transition: .4s;
}
.slider:before {
    position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
    background-color: var(--switch-handle-bg); transition: .4s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
input:checked + .slider { background-color: var(--focus-color); }
input:focus + .slider { box-shadow: 0 0 1px var(--focus-color); }
input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 34px; }
.slider.round:before { border-radius: 50%; }

.custom-tooltip {
    position: fixed; z-index: 5000; padding: 6px 12px; background-color: var(--modal-bg); color: var(--text-color);
    border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px var(--modal-shadow);
    font-size: 13px; font-weight: 500; line-height: 1.4; max-width: 200px; text-align: center; pointer-events: none;
    opacity: 0; transform: scale(0.95) translateY(5px); transition: opacity 0.15s ease, transform 0.15s ease;
}
.custom-tooltip.visible { opacity: 1; transform: scale(1) translateY(0); }

/* ==========================================================================
   8. Fullscreen & Toast
   ========================================================================== */
.fullscreen-overlay {
    position: fixed; inset: 0; z-index: 3000; background-color: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none;
    align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.3s ease;
}
.fullscreen-close-btn {
    position: absolute; top: 20px; right: 20px; width: 44px; height: 44px;
    border: none; background: rgba(255, 255, 255, 0.1); color: white; font-size: 30px; line-height: 1;
    border-radius: 50%; cursor: pointer; transition: transform 0.2s, background-color 0.2s;
}
.fullscreen-close-btn:hover { transform: scale(1.1); background: rgba(255, 255, 255, 0.2); }
.fullscreen-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
.fullscreen-content img, .fullscreen-content video { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
.fullscreen-content svg { width: 100%; height: 100%; max-width: 90vw; max-height: 90vh; object-fit: contain; }
.fullscreen-content iframe { width: 100%; height: 100%; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff; }

#toast-container {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 4000;
    display: flex; flex-direction: column-reverse; gap: 10px; align-items: center;
}
.toast-message {
    padding: 12px 20px; color: var(--button-text); background-color: var(--button-bg); border-radius: 25px;
    box-shadow: 0 4px 12px var(--modal-shadow); opacity: 0; transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease; font-size: 14px; font-weight: 500;
}
.toast-message.show { opacity: 1; transform: translateY(0); }
.toast-message.error { background-color: var(--danger-color); color: #fff; }
.toast-message.success { background-color: #4caf50; color: #fff; }
.toast-message.info { background-color: var(--button-bg); color: var(--button-text); }

/* ==========================================================================
   9. Accessibility & Screen Reader Support
   ========================================================================== */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Focus visible improvements */
*:focus-visible {
    outline: 2px solid var(--focus-color);
    outline-offset: 2px;
}

button:focus-visible,
a:focus-visible,
input:focus-visible,
textarea:focus-visible,
select:focus-visible {
    outline: 2px solid var(--focus-color);
    outline-offset: 2px;
    border-radius: 4px;
}

/* Skip to main content link */
.skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--button-bg);
    color: var(--button-text);
    padding: 8px;
    text-decoration: none;
    z-index: 10000;
}

.skip-link:focus {
    top: 0;
}

/* ==========================================================================
   10. Media Queries
   ========================================================================== */
@media (max-width: 768px) {
    .message-content { max-width: 92%; }
    .chat-input-container { padding: 10px; }
    .chat-input-wrapper { gap: 2px; }
    .sidebar-header { padding-top: 60px; }
    .settings-card { width: 95%; max-height: 80vh; padding: 15px; }
    
    /* Stronger mobile table enforcement */
    .message-content table {
        display: block;
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    /* Improve touch targets on mobile */
    button, a, input, textarea {
        min-height: 44px;
        min-width: 44px;
    }
}
@media (min-width: 769px) {
    .sidebar { position: relative; left: auto; margin-left: -281px; box-shadow: none; transition: margin-left 0.35s ease-in-out; }
    body.sidebar-open .sidebar { margin-left: 0; left: auto; }
    .sidebar-backdrop { display: none; }
    body.sidebar-open #sidebar-toggle { left: 276px; }
}

/* ==========================================================================
   11. Syntax Highlighting Token Maps
   ========================================================================== */
.token.comment { color: var(--token-comment); font-style: italic; }
.token.prolog, .token.cdata { color: var(--token-comment); font-style: italic; }
.token.doctype { color: var(--token-doctype); font-style: italic; }
.token.punctuation { color: var(--token-punctuation); }
.token.property, .token.boolean, .token.number, .token.constant, .token.symbol, .token.deleted { color: var(--token-number); }
.token.selector, .token.builtin, .token.inserted { color: var(--token-selector); }
.token.string, .token.attr-value { color: var(--token-string); }
.token.operator, .token.entity, .token.url { color: var(--token-operator); }
.token.keyword { color: var(--token-keyword); }
.token.function { color: var(--token-function); }
.token.class-name, .token.jbai-keyword { color: var(--token-class-name); font-weight: bold; }
.token.variable { color: var(--token-variable); }
.token.tag { color: var(--token-tag); }
.token.attr-name { color: var(--token-attr-name); }
.token.label { color: var(--token-label); font-weight: bold; }